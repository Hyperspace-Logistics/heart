package modules

import (
	"encoding/base64"
	"fmt"

	"github.com/aarzilli/golua/lua"
)

// LoadJSON module
func LoadJSON(state *lua.State) error {
	// I made this module base64 because it had a lot of characters that were escaping the string
	// Source: https://github.com/rxi/json.lua
	jsonLua, err := base64.RawStdEncoding.DecodeString("LS0KLS0ganNvbi5sdWEKLS0KLS0gQ29weXJpZ2h0IChjKSAyMDIwIHJ4aQotLQotLSBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5IG9mCi0tIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluCi0tIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8KLS0gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMKLS0gb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvCi0tIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczoKLS0KLS0gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4gYWxsCi0tIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCi0tCi0tIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCi0tIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAotLSBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKLS0gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgotLSBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAotLSBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRQotLSBTT0ZUV0FSRS4KLS0KCmxvY2FsIGpzb24gPSB7IF92ZXJzaW9uID0gIjAuMS4yIiB9CgotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCi0tIEVuY29kZQotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgpsb2NhbCBlbmNvZGUKCmxvY2FsIGVzY2FwZV9jaGFyX21hcCA9IHsKICBbICJcXCIgXSA9ICJcXCIsCiAgWyAiXCIiIF0gPSAiXCIiLAogIFsgIlxiIiBdID0gImIiLAogIFsgIlxmIiBdID0gImYiLAogIFsgIlxuIiBdID0gIm4iLAogIFsgIlxyIiBdID0gInIiLAogIFsgIlx0IiBdID0gInQiLAp9Cgpsb2NhbCBlc2NhcGVfY2hhcl9tYXBfaW52ID0geyBbICIvIiBdID0gIi8iIH0KZm9yIGssIHYgaW4gcGFpcnMoZXNjYXBlX2NoYXJfbWFwKSBkbwogIGVzY2FwZV9jaGFyX21hcF9pbnZbdl0gPSBrCmVuZAoKCmxvY2FsIGZ1bmN0aW9uIGVzY2FwZV9jaGFyKGMpCiAgcmV0dXJuICJcXCIgLi4gKGVzY2FwZV9jaGFyX21hcFtjXSBvciBzdHJpbmcuZm9ybWF0KCJ1JTA0eCIsIGM6Ynl0ZSgpKSkKZW5kCgoKbG9jYWwgZnVuY3Rpb24gZW5jb2RlX25pbCh2YWwpCiAgcmV0dXJuICJudWxsIgplbmQKCgpsb2NhbCBmdW5jdGlvbiBlbmNvZGVfdGFibGUodmFsLCBzdGFjaykKICBsb2NhbCByZXMgPSB7fQogIHN0YWNrID0gc3RhY2sgb3Ige30KCiAgLS0gQ2lyY3VsYXIgcmVmZXJlbmNlPwogIGlmIHN0YWNrW3ZhbF0gdGhlbiBlcnJvcigiY2lyY3VsYXIgcmVmZXJlbmNlIikgZW5kCgogIHN0YWNrW3ZhbF0gPSB0cnVlCgogIGlmIHJhd2dldCh2YWwsIDEpIH49IG5pbCBvciBuZXh0KHZhbCkgPT0gbmlsIHRoZW4KICAgIC0tIFRyZWF0IGFzIGFycmF5IC0tIGNoZWNrIGtleXMgYXJlIHZhbGlkIGFuZCBpdCBpcyBub3Qgc3BhcnNlCiAgICBsb2NhbCBuID0gMAogICAgZm9yIGsgaW4gcGFpcnModmFsKSBkbwogICAgICBpZiB0eXBlKGspIH49ICJudW1iZXIiIHRoZW4KICAgICAgICBlcnJvcigiaW52YWxpZCB0YWJsZTogbWl4ZWQgb3IgaW52YWxpZCBrZXkgdHlwZXMiKQogICAgICBlbmQKICAgICAgbiA9IG4gKyAxCiAgICBlbmQKICAgIGlmIG4gfj0gI3ZhbCB0aGVuCiAgICAgIGVycm9yKCJpbnZhbGlkIHRhYmxlOiBzcGFyc2UgYXJyYXkiKQogICAgZW5kCiAgICAtLSBFbmNvZGUKICAgIGZvciBpLCB2IGluIGlwYWlycyh2YWwpIGRvCiAgICAgIHRhYmxlLmluc2VydChyZXMsIGVuY29kZSh2LCBzdGFjaykpCiAgICBlbmQKICAgIHN0YWNrW3ZhbF0gPSBuaWwKICAgIHJldHVybiAiWyIgLi4gdGFibGUuY29uY2F0KHJlcywgIiwiKSAuLiAiXSIKCiAgZWxzZQogICAgLS0gVHJlYXQgYXMgYW4gb2JqZWN0CiAgICBmb3IgaywgdiBpbiBwYWlycyh2YWwpIGRvCiAgICAgIGlmIHR5cGUoaykgfj0gInN0cmluZyIgdGhlbgogICAgICAgIGVycm9yKCJpbnZhbGlkIHRhYmxlOiBtaXhlZCBvciBpbnZhbGlkIGtleSB0eXBlcyIpCiAgICAgIGVuZAogICAgICB0YWJsZS5pbnNlcnQocmVzLCBlbmNvZGUoaywgc3RhY2spIC4uICI6IiAuLiBlbmNvZGUodiwgc3RhY2spKQogICAgZW5kCiAgICBzdGFja1t2YWxdID0gbmlsCiAgICByZXR1cm4gInsiIC4uIHRhYmxlLmNvbmNhdChyZXMsICIsIikgLi4gIn0iCiAgZW5kCmVuZAoKCmxvY2FsIGZ1bmN0aW9uIGVuY29kZV9zdHJpbmcodmFsKQogIHJldHVybiAnIicgLi4gdmFsOmdzdWIoJ1slelwxLVwzMVxcIl0nLCBlc2NhcGVfY2hhcikgLi4gJyInCmVuZAoKCmxvY2FsIGZ1bmN0aW9uIGVuY29kZV9udW1iZXIodmFsKQogIC0tIENoZWNrIGZvciBOYU4sIC1pbmYgYW5kIGluZgogIGlmIHZhbCB+PSB2YWwgb3IgdmFsIDw9IC1tYXRoLmh1Z2Ugb3IgdmFsID49IG1hdGguaHVnZSB0aGVuCiAgICBlcnJvcigidW5leHBlY3RlZCBudW1iZXIgdmFsdWUgJyIgLi4gdG9zdHJpbmcodmFsKSAuLiAiJyIpCiAgZW5kCiAgcmV0dXJuIHN0cmluZy5mb3JtYXQoIiUuMTRnIiwgdmFsKQplbmQKCgpsb2NhbCB0eXBlX2Z1bmNfbWFwID0gewogIFsgIm5pbCIgICAgIF0gPSBlbmNvZGVfbmlsLAogIFsgInRhYmxlIiAgIF0gPSBlbmNvZGVfdGFibGUsCiAgWyAic3RyaW5nIiAgXSA9IGVuY29kZV9zdHJpbmcsCiAgWyAibnVtYmVyIiAgXSA9IGVuY29kZV9udW1iZXIsCiAgWyAiYm9vbGVhbiIgXSA9IHRvc3RyaW5nLAp9CgoKZW5jb2RlID0gZnVuY3Rpb24odmFsLCBzdGFjaykKICBsb2NhbCB0ID0gdHlwZSh2YWwpCiAgbG9jYWwgZiA9IHR5cGVfZnVuY19tYXBbdF0KICBpZiBmIHRoZW4KICAgIHJldHVybiBmKHZhbCwgc3RhY2spCiAgZW5kCiAgZXJyb3IoInVuZXhwZWN0ZWQgdHlwZSAnIiAuLiB0IC4uICInIikKZW5kCgoKZnVuY3Rpb24ganNvbi5lbmNvZGUodmFsKQogIHJldHVybiAoIGVuY29kZSh2YWwpICkKZW5kCgoKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQotLSBEZWNvZGUKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKbG9jYWwgcGFyc2UKCmxvY2FsIGZ1bmN0aW9uIGNyZWF0ZV9zZXQoLi4uKQogIGxvY2FsIHJlcyA9IHt9CiAgZm9yIGkgPSAxLCBzZWxlY3QoIiMiLCAuLi4pIGRvCiAgICByZXNbIHNlbGVjdChpLCAuLi4pIF0gPSB0cnVlCiAgZW5kCiAgcmV0dXJuIHJlcwplbmQKCmxvY2FsIHNwYWNlX2NoYXJzICAgPSBjcmVhdGVfc2V0KCIgIiwgIlx0IiwgIlxyIiwgIlxuIikKbG9jYWwgZGVsaW1fY2hhcnMgICA9IGNyZWF0ZV9zZXQoIiAiLCAiXHQiLCAiXHIiLCAiXG4iLCAiXSIsICJ9IiwgIiwiKQpsb2NhbCBlc2NhcGVfY2hhcnMgID0gY3JlYXRlX3NldCgiXFwiLCAiLyIsICciJywgImIiLCAiZiIsICJuIiwgInIiLCAidCIsICJ1IikKbG9jYWwgbGl0ZXJhbHMgICAgICA9IGNyZWF0ZV9zZXQoInRydWUiLCAiZmFsc2UiLCAibnVsbCIpCgpsb2NhbCBsaXRlcmFsX21hcCA9IHsKICBbICJ0cnVlIiAgXSA9IHRydWUsCiAgWyAiZmFsc2UiIF0gPSBmYWxzZSwKICBbICJudWxsIiAgXSA9IG5pbCwKfQoKCmxvY2FsIGZ1bmN0aW9uIG5leHRfY2hhcihzdHIsIGlkeCwgc2V0LCBuZWdhdGUpCiAgZm9yIGkgPSBpZHgsICNzdHIgZG8KICAgIGlmIHNldFtzdHI6c3ViKGksIGkpXSB+PSBuZWdhdGUgdGhlbgogICAgICByZXR1cm4gaQogICAgZW5kCiAgZW5kCiAgcmV0dXJuICNzdHIgKyAxCmVuZAoKCmxvY2FsIGZ1bmN0aW9uIGRlY29kZV9lcnJvcihzdHIsIGlkeCwgbXNnKQogIGxvY2FsIGxpbmVfY291bnQgPSAxCiAgbG9jYWwgY29sX2NvdW50ID0gMQogIGZvciBpID0gMSwgaWR4IC0gMSBkbwogICAgY29sX2NvdW50ID0gY29sX2NvdW50ICsgMQogICAgaWYgc3RyOnN1YihpLCBpKSA9PSAiXG4iIHRoZW4KICAgICAgbGluZV9jb3VudCA9IGxpbmVfY291bnQgKyAxCiAgICAgIGNvbF9jb3VudCA9IDEKICAgIGVuZAogIGVuZAogIGVycm9yKCBzdHJpbmcuZm9ybWF0KCIlcyBhdCBsaW5lICVkIGNvbCAlZCIsIG1zZywgbGluZV9jb3VudCwgY29sX2NvdW50KSApCmVuZAoKCmxvY2FsIGZ1bmN0aW9uIGNvZGVwb2ludF90b191dGY4KG4pCiAgLS0gaHR0cDovL3NjcmlwdHMuc2lsLm9yZy9jbXMvc2NyaXB0cy9wYWdlLnBocD9zaXRlX2lkPW5yc2kmaWQ9aXdzLWFwcGVuZGl4YQogIGxvY2FsIGYgPSBtYXRoLmZsb29yCiAgaWYgbiA8PSAweDdmIHRoZW4KICAgIHJldHVybiBzdHJpbmcuY2hhcihuKQogIGVsc2VpZiBuIDw9IDB4N2ZmIHRoZW4KICAgIHJldHVybiBzdHJpbmcuY2hhcihmKG4gLyA2NCkgKyAxOTIsIG4gJSA2NCArIDEyOCkKICBlbHNlaWYgbiA8PSAweGZmZmYgdGhlbgogICAgcmV0dXJuIHN0cmluZy5jaGFyKGYobiAvIDQwOTYpICsgMjI0LCBmKG4gJSA0MDk2IC8gNjQpICsgMTI4LCBuICUgNjQgKyAxMjgpCiAgZWxzZWlmIG4gPD0gMHgxMGZmZmYgdGhlbgogICAgcmV0dXJuIHN0cmluZy5jaGFyKGYobiAvIDI2MjE0NCkgKyAyNDAsIGYobiAlIDI2MjE0NCAvIDQwOTYpICsgMTI4LAogICAgICAgICAgICAgICAgICAgICAgIGYobiAlIDQwOTYgLyA2NCkgKyAxMjgsIG4gJSA2NCArIDEyOCkKICBlbmQKICBlcnJvciggc3RyaW5nLmZvcm1hdCgiaW52YWxpZCB1bmljb2RlIGNvZGVwb2ludCAnJXgnIiwgbikgKQplbmQKCgpsb2NhbCBmdW5jdGlvbiBwYXJzZV91bmljb2RlX2VzY2FwZShzKQogIGxvY2FsIG4xID0gdG9udW1iZXIoIHM6c3ViKDEsIDQpLCAgMTYgKQogIGxvY2FsIG4yID0gdG9udW1iZXIoIHM6c3ViKDcsIDEwKSwgMTYgKQogICAtLSBTdXJyb2dhdGUgcGFpcj8KICBpZiBuMiB0aGVuCiAgICByZXR1cm4gY29kZXBvaW50X3RvX3V0ZjgoKG4xIC0gMHhkODAwKSAqIDB4NDAwICsgKG4yIC0gMHhkYzAwKSArIDB4MTAwMDApCiAgZWxzZQogICAgcmV0dXJuIGNvZGVwb2ludF90b191dGY4KG4xKQogIGVuZAplbmQKCgpsb2NhbCBmdW5jdGlvbiBwYXJzZV9zdHJpbmcoc3RyLCBpKQogIGxvY2FsIHJlcyA9ICIiCiAgbG9jYWwgaiA9IGkgKyAxCiAgbG9jYWwgayA9IGoKCiAgd2hpbGUgaiA8PSAjc3RyIGRvCiAgICBsb2NhbCB4ID0gc3RyOmJ5dGUoaikKCiAgICBpZiB4IDwgMzIgdGhlbgogICAgICBkZWNvZGVfZXJyb3Ioc3RyLCBqLCAiY29udHJvbCBjaGFyYWN0ZXIgaW4gc3RyaW5nIikKCiAgICBlbHNlaWYgeCA9PSA5MiB0aGVuIC0tIGBcYDogRXNjYXBlCiAgICAgIHJlcyA9IHJlcyAuLiBzdHI6c3ViKGssIGogLSAxKQogICAgICBqID0gaiArIDEKICAgICAgbG9jYWwgYyA9IHN0cjpzdWIoaiwgaikKICAgICAgaWYgYyA9PSAidSIgdGhlbgogICAgICAgIGxvY2FsIGhleCA9IHN0cjptYXRjaCgiXltkRF1bODlhQWJCXSV4JXhcXHUleCV4JXgleCIsIGogKyAxKQogICAgICAgICAgICAgICAgIG9yIHN0cjptYXRjaCgiXiV4JXgleCV4IiwgaiArIDEpCiAgICAgICAgICAgICAgICAgb3IgZGVjb2RlX2Vycm9yKHN0ciwgaiAtIDEsICJpbnZhbGlkIHVuaWNvZGUgZXNjYXBlIGluIHN0cmluZyIpCiAgICAgICAgcmVzID0gcmVzIC4uIHBhcnNlX3VuaWNvZGVfZXNjYXBlKGhleCkKICAgICAgICBqID0gaiArICNoZXgKICAgICAgZWxzZQogICAgICAgIGlmIG5vdCBlc2NhcGVfY2hhcnNbY10gdGhlbgogICAgICAgICAgZGVjb2RlX2Vycm9yKHN0ciwgaiAtIDEsICJpbnZhbGlkIGVzY2FwZSBjaGFyICciIC4uIGMgLi4gIicgaW4gc3RyaW5nIikKICAgICAgICBlbmQKICAgICAgICByZXMgPSByZXMgLi4gZXNjYXBlX2NoYXJfbWFwX2ludltjXQogICAgICBlbmQKICAgICAgayA9IGogKyAxCgogICAgZWxzZWlmIHggPT0gMzQgdGhlbiAtLSBgImA6IEVuZCBvZiBzdHJpbmcKICAgICAgcmVzID0gcmVzIC4uIHN0cjpzdWIoaywgaiAtIDEpCiAgICAgIHJldHVybiByZXMsIGogKyAxCiAgICBlbmQKCiAgICBqID0gaiArIDEKICBlbmQKCiAgZGVjb2RlX2Vycm9yKHN0ciwgaSwgImV4cGVjdGVkIGNsb3NpbmcgcXVvdGUgZm9yIHN0cmluZyIpCmVuZAoKCmxvY2FsIGZ1bmN0aW9uIHBhcnNlX251bWJlcihzdHIsIGkpCiAgbG9jYWwgeCA9IG5leHRfY2hhcihzdHIsIGksIGRlbGltX2NoYXJzKQogIGxvY2FsIHMgPSBzdHI6c3ViKGksIHggLSAxKQogIGxvY2FsIG4gPSB0b251bWJlcihzKQogIGlmIG5vdCBuIHRoZW4KICAgIGRlY29kZV9lcnJvcihzdHIsIGksICJpbnZhbGlkIG51bWJlciAnIiAuLiBzIC4uICInIikKICBlbmQKICByZXR1cm4gbiwgeAplbmQKCgpsb2NhbCBmdW5jdGlvbiBwYXJzZV9saXRlcmFsKHN0ciwgaSkKICBsb2NhbCB4ID0gbmV4dF9jaGFyKHN0ciwgaSwgZGVsaW1fY2hhcnMpCiAgbG9jYWwgd29yZCA9IHN0cjpzdWIoaSwgeCAtIDEpCiAgaWYgbm90IGxpdGVyYWxzW3dvcmRdIHRoZW4KICAgIGRlY29kZV9lcnJvcihzdHIsIGksICJpbnZhbGlkIGxpdGVyYWwgJyIgLi4gd29yZCAuLiAiJyIpCiAgZW5kCiAgcmV0dXJuIGxpdGVyYWxfbWFwW3dvcmRdLCB4CmVuZAoKCmxvY2FsIGZ1bmN0aW9uIHBhcnNlX2FycmF5KHN0ciwgaSkKICBsb2NhbCByZXMgPSB7fQogIGxvY2FsIG4gPSAxCiAgaSA9IGkgKyAxCiAgd2hpbGUgMSBkbwogICAgbG9jYWwgeAogICAgaSA9IG5leHRfY2hhcihzdHIsIGksIHNwYWNlX2NoYXJzLCB0cnVlKQogICAgLS0gRW1wdHkgLyBlbmQgb2YgYXJyYXk/CiAgICBpZiBzdHI6c3ViKGksIGkpID09ICJdIiB0aGVuCiAgICAgIGkgPSBpICsgMQogICAgICBicmVhawogICAgZW5kCiAgICAtLSBSZWFkIHRva2VuCiAgICB4LCBpID0gcGFyc2Uoc3RyLCBpKQogICAgcmVzW25dID0geAogICAgbiA9IG4gKyAxCiAgICAtLSBOZXh0IHRva2VuCiAgICBpID0gbmV4dF9jaGFyKHN0ciwgaSwgc3BhY2VfY2hhcnMsIHRydWUpCiAgICBsb2NhbCBjaHIgPSBzdHI6c3ViKGksIGkpCiAgICBpID0gaSArIDEKICAgIGlmIGNociA9PSAiXSIgdGhlbiBicmVhayBlbmQKICAgIGlmIGNociB+PSAiLCIgdGhlbiBkZWNvZGVfZXJyb3Ioc3RyLCBpLCAiZXhwZWN0ZWQgJ10nIG9yICcsJyIpIGVuZAogIGVuZAogIHJldHVybiByZXMsIGkKZW5kCgoKbG9jYWwgZnVuY3Rpb24gcGFyc2Vfb2JqZWN0KHN0ciwgaSkKICBsb2NhbCByZXMgPSB7fQogIGkgPSBpICsgMQogIHdoaWxlIDEgZG8KICAgIGxvY2FsIGtleSwgdmFsCiAgICBpID0gbmV4dF9jaGFyKHN0ciwgaSwgc3BhY2VfY2hhcnMsIHRydWUpCiAgICAtLSBFbXB0eSAvIGVuZCBvZiBvYmplY3Q/CiAgICBpZiBzdHI6c3ViKGksIGkpID09ICJ9IiB0aGVuCiAgICAgIGkgPSBpICsgMQogICAgICBicmVhawogICAgZW5kCiAgICAtLSBSZWFkIGtleQogICAgaWYgc3RyOnN1YihpLCBpKSB+PSAnIicgdGhlbgogICAgICBkZWNvZGVfZXJyb3Ioc3RyLCBpLCAiZXhwZWN0ZWQgc3RyaW5nIGZvciBrZXkiKQogICAgZW5kCiAgICBrZXksIGkgPSBwYXJzZShzdHIsIGkpCiAgICAtLSBSZWFkICc6JyBkZWxpbWl0ZXIKICAgIGkgPSBuZXh0X2NoYXIoc3RyLCBpLCBzcGFjZV9jaGFycywgdHJ1ZSkKICAgIGlmIHN0cjpzdWIoaSwgaSkgfj0gIjoiIHRoZW4KICAgICAgZGVjb2RlX2Vycm9yKHN0ciwgaSwgImV4cGVjdGVkICc6JyBhZnRlciBrZXkiKQogICAgZW5kCiAgICBpID0gbmV4dF9jaGFyKHN0ciwgaSArIDEsIHNwYWNlX2NoYXJzLCB0cnVlKQogICAgLS0gUmVhZCB2YWx1ZQogICAgdmFsLCBpID0gcGFyc2Uoc3RyLCBpKQogICAgLS0gU2V0CiAgICByZXNba2V5XSA9IHZhbAogICAgLS0gTmV4dCB0b2tlbgogICAgaSA9IG5leHRfY2hhcihzdHIsIGksIHNwYWNlX2NoYXJzLCB0cnVlKQogICAgbG9jYWwgY2hyID0gc3RyOnN1YihpLCBpKQogICAgaSA9IGkgKyAxCiAgICBpZiBjaHIgPT0gIn0iIHRoZW4gYnJlYWsgZW5kCiAgICBpZiBjaHIgfj0gIiwiIHRoZW4gZGVjb2RlX2Vycm9yKHN0ciwgaSwgImV4cGVjdGVkICd9JyBvciAnLCciKSBlbmQKICBlbmQKICByZXR1cm4gcmVzLCBpCmVuZAoKCmxvY2FsIGNoYXJfZnVuY19tYXAgPSB7CiAgWyAnIicgXSA9IHBhcnNlX3N0cmluZywKICBbICIwIiBdID0gcGFyc2VfbnVtYmVyLAogIFsgIjEiIF0gPSBwYXJzZV9udW1iZXIsCiAgWyAiMiIgXSA9IHBhcnNlX251bWJlciwKICBbICIzIiBdID0gcGFyc2VfbnVtYmVyLAogIFsgIjQiIF0gPSBwYXJzZV9udW1iZXIsCiAgWyAiNSIgXSA9IHBhcnNlX251bWJlciwKICBbICI2IiBdID0gcGFyc2VfbnVtYmVyLAogIFsgIjciIF0gPSBwYXJzZV9udW1iZXIsCiAgWyAiOCIgXSA9IHBhcnNlX251bWJlciwKICBbICI5IiBdID0gcGFyc2VfbnVtYmVyLAogIFsgIi0iIF0gPSBwYXJzZV9udW1iZXIsCiAgWyAidCIgXSA9IHBhcnNlX2xpdGVyYWwsCiAgWyAiZiIgXSA9IHBhcnNlX2xpdGVyYWwsCiAgWyAibiIgXSA9IHBhcnNlX2xpdGVyYWwsCiAgWyAiWyIgXSA9IHBhcnNlX2FycmF5LAogIFsgInsiIF0gPSBwYXJzZV9vYmplY3QsCn0KCgpwYXJzZSA9IGZ1bmN0aW9uKHN0ciwgaWR4KQogIGxvY2FsIGNociA9IHN0cjpzdWIoaWR4LCBpZHgpCiAgbG9jYWwgZiA9IGNoYXJfZnVuY19tYXBbY2hyXQogIGlmIGYgdGhlbgogICAgcmV0dXJuIGYoc3RyLCBpZHgpCiAgZW5kCiAgZGVjb2RlX2Vycm9yKHN0ciwgaWR4LCAidW5leHBlY3RlZCBjaGFyYWN0ZXIgJyIgLi4gY2hyIC4uICInIikKZW5kCgoKZnVuY3Rpb24ganNvbi5kZWNvZGUoc3RyKQogIGlmIHR5cGUoc3RyKSB+PSAic3RyaW5nIiB0aGVuCiAgICBlcnJvcigiZXhwZWN0ZWQgYXJndW1lbnQgb2YgdHlwZSBzdHJpbmcsIGdvdCAiIC4uIHR5cGUoc3RyKSkKICBlbmQKICBsb2NhbCByZXMsIGlkeCA9IHBhcnNlKHN0ciwgbmV4dF9jaGFyKHN0ciwgMSwgc3BhY2VfY2hhcnMsIHRydWUpKQogIGlkeCA9IG5leHRfY2hhcihzdHIsIGlkeCwgc3BhY2VfY2hhcnMsIHRydWUpCiAgaWYgaWR4IDw9ICNzdHIgdGhlbgogICAgZGVjb2RlX2Vycm9yKHN0ciwgaWR4LCAidHJhaWxpbmcgZ2FyYmFnZSIpCiAgZW5kCiAgcmV0dXJuIHJlcwplbmQKCgpyZXR1cm4ganNvbgoK")
	if err != nil {
		return fmt.Errorf("failed to load json module: %s", err)
	}

	return state.DoString(fmt.Sprintf("package.preload['heart.v1.json'] = function() %s end", string(jsonLua)))
}
